{% extends "base.html" %}

{% block title %}Analysis Results - Message Processor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Analysis Results</h2>
        <p class="text-muted">Analysis ID: {{ analysis_id }}</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                        data-bs-target="#overview" type="button">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="timeline-tab" data-bs-toggle="tab"
                        data-bs-target="#timeline" type="button">Timeline</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visualizations-tab" data-bs-toggle="tab"
                        data-bs-target="#visualizations" type="button">Visualizations</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="export-tab" data-bs-toggle="tab"
                        data-bs-target="#export" type="button">Export</button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="analysisTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>Analysis Summary</h5>
                        <div id="overviewContent">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Tab -->
            <div class="tab-pane fade" id="timeline" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>Message Timeline</h5>
                        <div id="timelineViz" style="height: 500px;"></div>
                    </div>
                </div>
            </div>

            <!-- Visualizations Tab -->
            <div class="tab-pane fade" id="visualizations" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5>Sentiment Analysis</h5>
                                <div id="sentimentViz" style="height: 400px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>Risk Distribution</h5>
                                <div id="riskViz" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>Pattern Categories</h5>
                                <div id="patternViz" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div class="tab-pane fade" id="export" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>Export Options</h5>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                        <h6>PDF Report</h6>
                                        <a href="/api/export/pdf/{{ analysis_id }}"
                                           class="btn btn-danger btn-sm">Download PDF</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-file-code fa-3x text-primary mb-3"></i>
                                        <h6>JSON Data</h6>
                                        <a href="/api/export/json/{{ analysis_id }}"
                                           class="btn btn-primary btn-sm">Download JSON</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                                        <h6>CSV Export</h6>
                                        <a href="/api/export/csv/{{ analysis_id }}"
                                           class="btn btn-success btn-sm">Download CSV</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
var analysisId = '{{ analysis_id }}';

$(document).ready(function() {
    loadAnalysisResults();
    loadSentimentVisualization();
});

function loadAnalysisResults() {
    $.ajax({
        url: '/api/analysis/' + analysisId + '/results',
        type: 'GET',
        success: function(data) {
            displayOverview(data);
        },
        error: function() {
            $('#overviewContent').html('<p class="text-danger">Failed to load results</p>');
        }
    });
}

function displayOverview(data) {
    var html = `
        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>Risk Level</h6>
                        <h3 class="text-${getRiskColor(data.risk ? data.risk.risk_level : 'unknown')}">
                            ${data.risk ? data.risk.risk_level.toUpperCase() : 'UNKNOWN'}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>Patterns Detected</h6>
                        <h3>${data.patterns ? data.patterns.length : 0}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h6>Status</h6>
                        <h3><span class="badge bg-success">Complete</span></h3>
                    </div>
                </div>
            </div>
        </div>
    `;

    $('#overviewContent').html(html);
}

function loadSentimentVisualization() {
    $.ajax({
        url: '/api/visualizations/' + analysisId + '/sentiment',
        type: 'GET',
        success: function(plotData) {
            Plotly.newPlot('sentimentViz', JSON.parse(plotData).data,
                          JSON.parse(plotData).layout);
        }
    });
}

function getRiskColor(level) {
    switch(level.toLowerCase()) {
        case 'critical': return 'danger';
        case 'high': return 'warning';
        case 'moderate': return 'info';
        case 'low': return 'success';
        default: return 'secondary';
    }
}
</script>
{% endblock %}
